# Security Audit: rusqlite v0.38.0

## Crate Information

| Field | Value |
|-------|-------|
| Name | rusqlite |
| Version | 0.38.0 |
| Description | Ergonomic wrapper for SQLite |
| Repository | https://github.com/rusqlite/rusqlite |
| Documentation | https://docs.rs/rusqlite/ |
| License | MIT |
| Total Downloads | 45,996,162 |
| Recent Downloads | 6,297,547 |
| First Published | November 21, 2014 |
| Latest Release | December 20, 2025 |

## Security Assessment

### RustSec Advisories

#### RUSTSEC-2021-0128: Incorrect Lifetime Bounds on Closures

| Field | Value |
|-------|-------|
| Advisory ID | RUSTSEC-2021-0128 |
| Date | December 9, 2021 |
| Severity | Memory corruption (use-after-free) |
| Affected Versions | 0.25.0 - 0.25.3, 0.26.0 - 0.26.1 |
| Patched Versions | >= 0.25.4, >= 0.26.2 |
| Status | **FIXED in v0.38.0** |

**Description:** Relaxed lifetime constraints on closure parameters in
callback-registration functions allowed Rust code to access stack objects after
they were dropped, leading to potential use-after-free vulnerabilities.

**Impacted Functions:**

- `create_scalar_function` (functions feature)
- `create_aggregate_function` (functions feature)
- `create_window_function` (functions feature)
- `commit_hook` (hooks feature)
- `rollback_hook` (hooks feature)
- `update_hook` (hooks feature)
- `create_collation` (collation feature)

**Current Status:** Version 0.38.0 is not affected by this vulnerability.

### SQL Injection Protection Analysis

#### Parameterized Query Support

Rusqlite provides strong SQL injection protection through its API design:

1. **Prepared Statements:** The `Statement` struct pre-compiles SQL, preventing
   injection by separating query structure from data.

2. **Parameter Binding Macros:**
   - `params!` - Positional parameters as `&[&dyn ToSql]`
   - `named_params!` - Named parameters as `&[(&str, &dyn ToSql)]`

3. **Type-Safe Parameter Passing:**

   ```rust
   // Safe: Parameters are bound, not concatenated
   conn.execute(
       "INSERT INTO person (name, data) VALUES (?1, ?2)",
       (&me.name, &me.data),
   )?;
   ```

4. **ToSql Trait:** Ensures proper type conversion and escaping of values at
   the type system level.

#### Security Architecture

- SQL structure and user data are architecturally separated
- Type system enforces separation at compile time
- String concatenation for queries is discouraged by API design
- Prepared statements are the primary query mechanism

### Security Considerations

#### Extension Loading Risk

The `load_extension` feature allows loading dynamic SQLite extensions, which
could introduce risks if loading untrusted compiled code. This feature should
be used cautiously and only with trusted extensions.

#### Encryption Support

The crate supports SQLCipher through optional features for encrypted database
support:

- `bundled-sqlcipher` - Bundled SQLCipher
- `bundled-sqlcipher-vendored-openssl` - With vendored OpenSSL

### Feature Security Matrix

| Feature | Security Implication |
|---------|---------------------|
| `bundled` | Bundles SQLite, version controlled |
| `sqlcipher` | Enables database encryption |
| `load_extension` | Risk: Can load arbitrary code |
| `functions` | Custom SQL functions (previously affected by RUSTSEC-2021-0128) |
| `hooks` | Database hooks (previously affected by RUSTSEC-2021-0128) |
| `collation` | Custom collation (previously affected by RUSTSEC-2021-0128) |

## Recommendations

1. **Version:** Use v0.38.0 or later (no known vulnerabilities)
2. **Queries:** Always use parameterized queries with `params!` or
   `named_params!` macros
3. **Extensions:** Avoid `load_extension` feature unless absolutely necessary
4. **Encryption:** Consider `sqlcipher` feature for sensitive data at rest
5. **Updates:** Monitor RustSec for new advisories

## Audit Metadata

| Field | Value |
|-------|-------|
| Audit Date | 2026-02-01 |
| Audited Version | 0.38.0 |
| Known Vulnerabilities | 0 (in current version) |
| Historical Vulnerabilities | 1 (RUSTSEC-2021-0128, fixed) |
| SQL Injection Protection | Strong (parameterized queries) |
| Recommendation | **APPROVED** |
